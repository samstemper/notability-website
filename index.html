<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Notable Americans by County of Birth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <style>
    .year-range {
      font-size: 12px;
      color: #9ca3af;
      margin-top: -4px;
      margin-bottom: 6px;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #f9fafb;
    }

    #app {
      display: grid;
      grid-template-columns: minmax(260px, 380px) 1fr;
      height: 100%;
    }

    .sidebar {
      padding: 18px 20px;
      background: radial-gradient(circle at top left, #111827, #020617);
      border-right: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow: hidden; /* so internal panel scrolls */
    }

    .sidebar-top {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .sidebar h1 {
      font-size: 20px;
      margin: 0;
      line-height: 1.3;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      line-height: 1.4;
    }

    label {
      font-size: 12px;
      color: #d1d5db;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
      display: block;
    }

    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
    }

    select:focus {
      border-color: #a855f7;
      box-shadow: 0 0 0 1px rgba(168, 85, 247, 0.7);
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
    }

    .legend {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 12px;
      color: #e5e7eb;
    }

    .legend-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .legend-scale {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .legend-gradient {
      flex: 1;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, #e8f3ff, #3b82f6, #0f172a);
    }

    .legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(55, 65, 81, 0.8);
      color: #d1d5db;
      border: 1px solid rgba(75, 85, 99, 0.9);
      gap: 6px;
      margin-top: 4px;
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #f97316, #a855f7);
    }

    /* People panel */
    .people-panel {
      flex: 1 1 auto;
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(55, 65, 81, 0.85);
      display: flex;
      flex-direction: column;
      min-height: 0; /* Important for flex scrolling */
    }

    .people-header {
      flex: 0 0 auto;
      margin-bottom: 8px;
    }

    .people-title {
      font-size: 13px;
      font-weight: 600;
    }

    .people-subtitle {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .people-list {
      flex: 1 1 auto;
      margin-top: 8px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .person-card {
      padding: 8px 8px;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top left, #020617, #020617);
      margin-bottom: 6px;
      font-size: 12px;
    }

    .person-name {
      font-weight: 600;
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .person-name a {
      color: #e5e7eb;
      text-decoration: none;
    }

    .person-name a:hover {
      text-decoration: underline;
      text-decoration-color: #a855f7;
    }

    .person-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .person-pageviews {
      font-size: 11px;
      color: #a5b4fc;
    }

    .person-tag {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(79, 70, 229, 0.7);
      background: rgba(30, 64, 175, 0.45);
      color: #c7d2fe;
    }

    /* Info section */
    .info-section {
      flex: 0 0 auto;
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 11px;
      color: #d1d5db;
    }

    .info-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .info-body {
      font-size: 11px;
      color: #9ca3af;
      line-height: 1.5;
      margin: 0 0 6px 0;
    }

    .info-link {
      font-size: 11px;
      color: #60a5fa;
      text-decoration: none;
    }

    .info-link:hover {
      text-decoration: underline;
      text-decoration-color: #60a5fa;
    }

    #map {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .maplibregl-canvas-container {
      filter: saturate(1.05);
    }

    /* Tooltip */
    .tooltip {
      position: absolute;
      pointer-events: none;
      background: rgba(15, 23, 42, 0.98);
      color: #e5e7eb;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(55, 65, 81, 0.9);
      transform: translate(-50%, calc(-100% - 8px));
      z-index: 10;
      min-width: 160px;
      display: none;
    }

    .tooltip-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .tooltip-value {
      color: #a5b4fc;
      font-weight: 500;
    }

    .tooltip-sub {
      color: #9ca3af;
      font-size: 11px;
      margin-top: 2px;
    }

    @media (max-width: 900px) {
      #app {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .sidebar {
        border-right: none;
        border-bottom: 1px solid #1f2937;
      }
      .people-panel {
        display: none;  /* hide clickable/list section on mobile */
      }
    }

  </style>
</head>
<body>
<div id="app">
  <div class="sidebar">
    <div class="sidebar-top">
      <div>
        <h1>Notable Americans by County</h1>
        <div class="year-range">1820–1980</div>
        <p class="subtitle">
          This map shows how many notable Americans were born in each continguous U.S. county, measured as the number of people with a Wikipedia page per 10,000 births.
          The data comes from my research (<a href="https://www.sciencedirect.com/science/article/pii/S0166046225000833" target="_blank" rel="noopener noreferrer">Stemper 2025</a>), which combines, manipulates, and analyzes notability data originally compiled by <a href="https://www.nature.com/articles/s41597-022-01369-4" target="_blank" rel="noopener noreferrer">Laouenan et al. (2022)</a> from Wikipedia and Wikidata.
        </p>
      </div>
      <div class="control-group">
        <select id="metric-select">
          <option value="rate_all" selected>All Occupations</option>
          <option value="rate_culture">Culture</option>
          <option value="rate_discovery">Discovery/Science</option>
          <option value="rate_leadership">Leadership</option>
          <option value="rate_sports">Sports</option>
        </select>
      </div>

      <div class="legend">
        <div class="legend-title" id="legend-title">
          Notability rate (per 10,000 births)
        </div>
        <div class="legend-scale">
          <span style="font-size:11px;color:#9ca3af;">Low</span>
          <div class="legend-gradient"></div>
          <span style="font-size:11px;color:#9ca3af;">High</span>
        </div>
        <div class="legend-labels">
          <span id="legend-min">0</span>
          <span id="legend-mid">10</span>
          <span id="legend-max">20+</span>
        </div>
      </div>
    </div>

    <!-- CLICK-DRIVEN PEOPLE LIST -->
    <div class="people-panel">
      <div class="people-header">
        <div class="people-title" id="people-title">
          Click a county on the map
        </div>
        <div class="people-subtitle" id="people-subtitle">
          Top Wikipedia pages (by 2015-2018 page views) will appear here.
        </div>
      </div>
      <div class="people-list" id="people-list">
        <!-- dynamically filled -->
      </div>
    </div>

    </div>

  <div id="map"></div>
</div>

<div id="tooltip" class="tooltip">
  <div class="tooltip-title" id="tooltip-title"></div>
  <div class="tooltip-value" id="tooltip-value"></div>
  <div class="tooltip-sub" id="tooltip-sub"></div>
</div>

<script>
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'simple-tiles': {
          type: 'raster',
          tiles: [
            'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
          ],
          tileSize: 256,
          attribution: '&copy; OpenStreetMap contributors'
        }
      },
      layers: [
        {
          id: 'simple-tiles',
          type: 'raster',
          source: 'simple-tiles'
        }
      ]
    },
    center: [-98.5, 39.8],
    zoom: 3.4,
    minZoom: 2,
    maxZoom: 8
  });

  const METRIC_LABELS = {
    rate_all: "All Occupations",
    rate_culture: "Culture",
    rate_discovery: "Discovery/Science",
    rate_leadership: "Leadership",
    rate_sports: "Sports"
  };

  const METRIC_GROUP_FILTER = {
    // No filtering for "all" – show everyone
    rate_all: null,
    rate_culture:   ["culture"],
    rate_discovery: ["discovery/science"],
    rate_leadership:["leadership"],
    rate_sports:    ["sports"]
  };

  const metricSelect = document.getElementById('metric-select');
  const legendTitle = document.getElementById('legend-title');
  const legendMin = document.getElementById('legend-min');
  const legendMid = document.getElementById('legend-mid');
  const legendMax = document.getElementById('legend-max');
  const tooltip = document.getElementById('tooltip');
  const ttTitle = document.getElementById('tooltip-title');
  const ttValue = document.getElementById('tooltip-value');
  const ttSub = document.getElementById('tooltip-sub');

  const peopleTitle = document.getElementById('people-title');
  const peopleSubtitle = document.getElementById('people-subtitle');
  const peopleListEl = document.getElementById('people-list');

  // Legend domains
  const scaleByMetric = {
    rate_all:       {min: 0, mid: 6,   max: 12},
    rate_culture:   {min: 0, mid: 2.5,   max: 5},
    rate_discovery: {min: 0, mid: 0.75,   max: 1.5},
    rate_leadership:{min: 0, mid: 2.5, max: 5},
    rate_sports:    {min: 0, mid: 2.5, max: 5}
  };

  function updateLegend(metric) {
    const s = scaleByMetric[metric] || scaleByMetric["rate_all"];
    legendTitle.textContent = `Notability Rate (Per 10,000 Births) – ${METRIC_LABELS[metric]}`;
    legendMin.textContent = s.min.toString();
    legendMid.textContent = s.mid.toString();
    legendMax.textContent = s.max + '+';
  }

  function makeFillColorExpression(metric) {
    const {min, mid, max} = scaleByMetric[metric] || scaleByMetric["rate_all"];
    return [
      'interpolate',
      ['linear'],
      ['get', metric],
      min, '#e8f3ff',
      mid, '#3b82f6',
      max, '#0f172a'
    ];
  }

  // Loaded from JSON later
  let countyPeople = {};

    // Render list of people for a county (filtered by metric)
  function renderPeoplePanel(countyName, stateName, geoid, metric) {
    const key = geoid || '';
    const basePeople = (countyPeople && countyPeople[key]) ? [...countyPeople[key]] : [];

    if (basePeople.length === 0) {
      peopleTitle.textContent = `${countyName}${stateName ? ', ' + stateName : ''}`;
      peopleSubtitle.textContent = 'No notable people in this dataset for this county.';
      peopleListEl.innerHTML = '';
      return;
    }

    // ----- FILTER BY METRIC -----
    let filtered = basePeople;
    const groups = METRIC_GROUP_FILTER[metric];

    if (Array.isArray(groups) && groups.length > 0) {
      const allowed = groups.map(g => g.toLowerCase());
      filtered = basePeople.filter(p => {
        const g = (p.occupation_group || "").toLowerCase();
        return allowed.includes(g);
      });

      // If nothing matches, show an empty list for this category
      if (filtered.length === 0) {
        const metricLabel = METRIC_LABELS[metric] || METRIC_LABELS['rate_all'];
        peopleTitle.textContent = `${countyName}${stateName ? ', ' + stateName : ''}`;
        peopleSubtitle.textContent = `No notable people in this category (${metricLabel}) for this county.`;
        peopleListEl.innerHTML = '';
        return;
      }
    }

    // Sort by pageviews descending
    filtered.sort((a, b) => (b.pageviews || 0) - (a.pageviews || 0));

    const countShown = Math.min(filtered.length, 25);
    const metricLabel = METRIC_LABELS[metric] || METRIC_LABELS['rate_all'];

    peopleTitle.textContent = `${countyName}${stateName ? ', ' + stateName : ''}`;
    peopleSubtitle.textContent = `Top ${countShown} Wikipedia pages by views – ${metricLabel}`;

    const cards = filtered.slice(0, 25).map((p, idx) => {
      const name = p.name || 'Unknown';
      const occupation = p.occupation_group || '';
      const birthYear = p.birth_year || '';
      const pageviews = p.pageviews || 0;
      const wikiUrl = p.wiki_url || null;

      const labelPieces = [];
      if (birthYear) labelPieces.push(`b. ${birthYear}`);

      const labelText = labelPieces.join('');

      return `
        <div class="person-card">
          <div class="person-name">
            <span>${idx + 1}. ${
              wikiUrl
                ? `<a href="${wikiUrl}" target="_blank" rel="noopener noreferrer">${name}</a>`
                : name
            }</span>
            ${occupation ? `<span class="person-tag">${occupation}</span>` : ''}
          </div>
          ${labelText ? `<div class="person-meta">${labelText}</div>` : ''}
          <div class="person-pageviews">
            ${pageviews.toLocaleString()} page views
          </div>
        </div>
      `;
    });

    peopleListEl.innerHTML = cards.join('');
  }

  // Load people JSON
  fetch('data/county_people.json')
    .then(res => res.json())
    .then(data => {
      countyPeople = data || {};
    })
    .catch(err => {
      console.warn('Failed to load county_people.json', err);
    });

  map.on('load', () => {
    map.addSource('notability', {
      type: 'geojson',
      data: 'data/counties_notability.geojson'
    });

    map.addLayer({
      id: 'notability-fill',
      type: 'fill',
      source: 'notability',
      paint: {
        'fill-color': makeFillColorExpression(metricSelect.value),
        'fill-opacity': [
          'case',
          ['>', ['get', metricSelect.value], 0],
          0.85,
          0.1
        ],
        'fill-outline-color': '#020617'
      }
    });

    map.addLayer({
      id: 'notability-outline',
      type: 'line',
      source: 'notability',
      paint: {
        'line-color': 'rgba(15,23,42,0.9)',
        'line-width': 0.3
      }
    });

    // Hover tooltip
    map.on('mousemove', 'notability-fill', (e) => {
      const f = e.features && e.features[0];
      if (!f) {
        tooltip.style.display = 'none';
        return;
      }
      const props = f.properties || {};
      const metric = metricSelect.value;
      const rate = props[metric];

      const countyName = props.NAME || props.name || 'Unknown county';
      const stateName = props.STATE_NAME || props.state || '';
      ttTitle.textContent = `${countyName}${stateName ? ', ' + stateName : ''}`;
      ttValue.textContent = `${(rate ?? 0).toFixed(2)} per 10,000 births`;
      ttSub.textContent = METRIC_LABELS[metric];

      const rect = map.getContainer().getBoundingClientRect();
      const x = e.point.x + rect.left;
      const y = e.point.y + rect.top;

      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y}px`;
      tooltip.style.display = 'block';
    });

    map.on('mouseleave', 'notability-fill', () => {
      tooltip.style.display = 'none';
    });

    map.on('mouseenter', 'notability-fill', () => {
      map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', 'notability-fill', () => {
      map.getCanvas().style.cursor = '';
    });

    // CLICK: update people panel
    map.on('click', 'notability-fill', (e) => {
      // On mobile, do nothing when clicking counties (people panel is hidden)
      if (window.innerWidth <= 900) {
        return;
      }

      const f = e.features && e.features[0];
      if (!f) return;

      const props = f.properties || {};
      const metric = metricSelect.value;

      const countyName = props.NAME || props.name || 'Unknown county';
      const stateName = props.STATE_NAME || props.state || '';
      const geoid = props.geoid || props.GEOID || props.GEOID10 || null;

      if (!geoid) {
        peopleTitle.textContent = `${countyName}${stateName ? ', ' + stateName : ''}`;
        peopleSubtitle.textContent = 'No county identifier available.';
        peopleListEl.innerHTML = '';
        return;
      }

      renderPeoplePanel(countyName, stateName, geoid, metric);
    });

    // Metric change
    metricSelect.addEventListener('change', () => {
      const metric = metricSelect.value;
      updateLegend(metric);

      map.setPaintProperty('notability-fill', 'fill-color', makeFillColorExpression(metric));
      map.setPaintProperty('notability-fill', 'fill-opacity', [
        'case',
        ['>', ['get', metric], 0],
        0.85,
        0.1
      ]);

      // If a county is already selected, you could re-render its panel here
      // by storing the last clicked county; for now, the next click will use the new filter.
    });

    updateLegend(metricSelect.value);
  });
</script>
</body>
</html>
